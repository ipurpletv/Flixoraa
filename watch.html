<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Watch</title>
  <style>
    /* ------ base / layout (unchanged) ------ */
    *{box-sizing:border-box;margin:0;padding:0}
    body{background:#0b0b0b;color:#fff;font-family:'Segoe UI',sans-serif;overflow-x:hidden}
    header{background:rgba(0,0,0,.7);backdrop-filter:blur(10px);padding:16px;display:flex;justify-content:space-between;position:sticky;top:0;z-index:10}
    header a{color:#00bfff;text-decoration:none;font-weight:600}
    #watch-title{font-size:1.5rem;padding:20px 24px;border-bottom:1px solid #222}
    .watch-container{display:flex;gap:24px;flex-wrap:wrap;padding:20px 24px}
    .video-box{flex:2;min-width:300px}
    .video-box iframe{width:100%;height:420px;border:none;border-radius:10px;background:#000}
    .server-select{margin-top:12px;display:flex;flex-wrap:wrap;gap:10px;align-items:center}
    .server-select label{font-size:.9rem}
    .server-select select{padding:6px;background:#222;color:#fff;border:1px solid #444;border-radius:4px;font-size:.9rem}
    .download-btn{background:#e50914;color:#fff;padding:6px 12px;font-size:.85rem;text-decoration:none;border-radius:4px}
    .recommendations{flex:1;min-width:250px;background:rgba(30,30,30,.8);backdrop-filter:blur(8px);padding:16px;border-radius:10px;height:460px;overflow-y:auto}
    .recommendations h3{font-size:1rem;margin-bottom:12px}
    .rec-item{display:flex;align-items:center;margin-bottom:10px;cursor:pointer;transition:transform .2s}
    .rec-item:hover{transform:scale(1.02)}
    .rec-item img{width:48px;height:72px;object-fit:cover;border-radius:4px;margin-right:10px}
    .rec-item span{font-size:.85rem;color:#ccc}
    @media(max-width:768px){
      #watch-title{font-size:1.2rem;padding:16px}
      .watch-container{flex-direction:column;padding:16px}
      .video-box iframe{height:240px}
      .recommendations{height:auto;max-height:300px;margin-top:20px}
      .rec-item img{width:40px;height:60px}
      .rec-item span{font-size:.8rem}
    }
  </style>
</head>
<body>
  <!-- ---------- NAV ---------- -->
  <header><a href="index.html">← Back to Homepage</a></header>

  <h2 id="watch-title">Loading…</h2>

  <!-- ---------- MAIN CONTAINER ---------- -->
  <div class="watch-container">
    <!-- video & controls -->
    <div class="video-box">
      <iframe id="watch-player" allowfullscreen></iframe>

      <div class="server-select">
        <label for="server">Server:</label>
        <select id="server">
          <option value="vidsrc.cc">Martina</option>
          <option value="vidsrc.me">Purple</option>
          <option value="player.videasy.net">Cuz (HD)</option>
          <option value="apimocine.movie">Cristina (4K)</option>
          <option value="apimocine.tv">Steechy (4K TV)</option>
        </select>

        <!-- season / episode (hidden for movies) -->
        <label id="season-label" for="season" style="display:none;">Season:</label>
        <select id="season" style="display:none;"></select>

        <label id="episode-label" for="episode" style="display:none;">Episode:</label>
        <select id="episode" style="display:none;"></select>

        <a id="watch-download-btn" class="download-btn" target="_blank" style="display:none;">Download</a>
      </div>
    </div>

    <!-- recommendations -->
    <div class="recommendations">
      <h3>For You</h3>
      <div id="recommend-list">Loading…</div>
    </div>
  </div>

  <!-- ---------- SCRIPT ---------- -->
  <script>
    const TMDB_KEY = 'ba0e2f64d29bae320cf0bbd091bbdf3f';

    /* URL params */
    const params = new URLSearchParams(location.search);
    const id    = params.get('id');
    const type  = params.get('type'); // 'movie' or 'tv'
    const title = decodeURIComponent(params.get('title') || 'Now Playing');

    /* DOM refs */
    const titleEl   = document.getElementById('watch-title');
    const player    = document.getElementById('watch-player');
    const serverSel = document.getElementById('server');
    const dlBtn     = document.getElementById('watch-download-btn');
    const seasonSel = document.getElementById('season');
    const episodeSel= document.getElementById('episode');
    const sLabel    = document.getElementById('season-label');
    const eLabel    = document.getElementById('episode-label');

    if (!id || !type){ titleEl.textContent='Invalid stream info.'; throw new Error('Missing id/type'); }
    titleEl.textContent = title;

    /* ---------- EMBED URL BUILDER ---------- */
    function buildEmbed(server){
      const s = seasonSel.value;
      const e = episodeSel.value;
      const hasSE = type==='tv' && s && e;
      let url='';
      if(server==='vidsrc.cc'){
        url = `https://vidsrc.cc/v2/embed/${type}/${id}?autoplay=1${hasSE?`&season=${s}&episode=${e}`:''}`;
      }else if(server==='vidsrc.me'){
        url = `https://vidsrc.net/embed/${type}/?tmdb=${id}&autoplay=1${hasSE?`&season=${s}&episode=${e}`:''}`;
      }else if(server==='player.videasy.net'){
        url = `https://player.videasy.net/${type}/${id}?autoplay=1${hasSE?`&season=${s}&episode=${e}`:''}`;
      }else if(server==='apimocine.movie'){
        url = `https://apimocine.vercel.app/movie/${id}`;
      }else if(server==='apimocine.tv'){
        url = `https://apimocine.vercel.app/tv/${id}${hasSE?`?season=${s}&episode=${e}`:''}`;
      }
      return url;
    }
    function updateEmbed(){ player.src = buildEmbed(serverSel.value); }

    /* ---------- DOWNLOAD FETCH ---------- */
    function updateDownload(){
      dlBtn.style.display='none';
      const isTV = type==='tv';
      const s = seasonSel.value;
      const e = episodeSel.value;
      const api =
        isTV ? `https://apimocine.vercel.app/tv/${id}?season=${s}&episode=${e}`
             : `https://apimocine.vercel.app/movie/${id}`;
      fetch(api).then(r=>r.json()).then(d=>{
        const link=d?.media?.sources?.find(src=>src.url)?.url;
        if(link){ dlBtn.href=link; dlBtn.style.display='inline-block'; }
      }).catch(()=>{ dlBtn.style.display='none'; });
    }

    /* ---------- SEASONS / EPISODES (TV only) ---------- */
    async function loadSeasons(){
      if(type!=='tv'){ sLabel.style.display=eLabel.style.display=seasonSel.style.display=episodeSel.style.display='none'; return; }

      // show selectors
      sLabel.style.display=seasonSel.style.display='inline-block';
      eLabel.style.display=episodeSel.style.display='inline-block';

      seasonSel.innerHTML=''; episodeSel.innerHTML='';
      const info=await fetch(`https://api.themoviedb.org/3/tv/${id}?api_key=${TMDB_KEY}`).then(r=>r.json());
      info.seasons.filter(sea=>sea.episode_count>0).forEach(sea=>{
        const opt=document.createElement('option');
        opt.value=sea.season_number;
        opt.textContent=sea.name ?? `Season ${sea.season_number}`;
        seasonSel.appendChild(opt);
      });
      await loadEpisodes();              // load ep for first season
      seasonSel.addEventListener('change', loadEpisodes);
    }
    async function loadEpisodes(){
      episodeSel.innerHTML='';
      const sNum=seasonSel.value;
      const eps=await fetch(`https://api.themoviedb.org/3/tv/${id}/season/${sNum}?api_key=${TMDB_KEY}`).then(r=>r.json());
      eps.episodes.forEach(ep=>{
        const opt=document.createElement('option');
        opt.value=ep.episode_number;
        opt.textContent=`E${ep.episode_number} • ${ep.name}`;
        episodeSel.appendChild(opt);
      });
      episodeSel.addEventListener('change', ()=>{ updateEmbed(); updateDownload(); });
      // After populating first time:
      updateEmbed(); updateDownload();
    }

    /* ---------- INIT ---------- */
    serverSel.addEventListener('change', ()=>{ updateEmbed(); updateDownload(); });
    updateEmbed(); // initial
    loadSeasons(); // maybe do nothing for movie
    updateDownload(); // initial fetch for movie

    /* ---------- TMDB recommendations ---------- */
    async function loadRecommendations(){
      const box=document.getElementById('recommend-list');
      box.innerHTML='';
      try{
        const data=await fetch(`https://api.themoviedb.org/3/${type}/${id}/recommendations?api_key=${TMDB_KEY}`).then(r=>r.json());
        if(!data.results.length){ box.innerHTML="<p style='color:#888'>No recommendations found.</p>"; return; }
        data.results.slice(0,10).forEach(it=>{
          if(!it.poster_path) return;
          const div=document.createElement('div');
          div.className='rec-item';
          div.innerHTML=`<img src="https://image.tmdb.org/t/p/w200${it.poster_path}" alt="">
                         <span>${it.title||it.name}</span>`;
          div.onclick=()=>location.href=`watch.html?id=${it.id}&type=${type}&title=${encodeURIComponent(it.title||it.name)}`;
          box.appendChild(div);
        });
      }catch(err){ box.innerHTML="<p style='color:red'>Error loading recommendations.</p>"; }
    }
    loadRecommendations();
  </script>
</body>
</html>
